var Q = require("q"),
    _ = require("lodash"),
    jQuery = require("jquery"),
    Storage = require("dom-storage"),
    jsdom = require("jsdom"),
    modDev = require("./device"),
    IoC = require("internal-ioc").IoC,
    getApiAddress = require("./get-api-address").getApiAddress,
    Promise = require("bluebird"),
    helpers = require("./helpers")
    iocModules = {};

var ioc = new IoC(iocModules, global)

var dom = new (jsdom.JSDOM)(
    '<!DOCTYPE html>',
    {
        url : "http://local-app.vocohub.com/demo/main/app/debugindex.html"
    }
)

ioc.define("window", dom.window)
var $ = jQuery(dom.window)
ioc.define("jQuery", $)
ioc.define("_", _)
ioc.define("Q", Q)
ioc.define("3r/storage", new Storage("./tmp.json"))

ioc.injectAll(helpers)

ioc.inject(getApiAddress)

var deviceFactory = ioc.inject(modDev.deviceFactory)

var Device = deviceFactory({ schemeId : 85 })

$(Device).on('registered', function (m) {
    console.log("Device Ids:", Device.deviceId, Device.thrid)
    Device.api(
        'registerDev',
        {
            mode : 'regGM',
            duid : Device.deviceId,
            uid : Device.thrid,
            validate : true,
            schemeId : 85,
            appName : 85,
            email : Date.now() + "@testing.com"
        },
        'post'
    ).then(function (res) {
        console.log("Reg GM:" , res)

        Device.updateThrid(res.results.uid)

        return Promise.delay(500)

    })
    .then(function () {
        return Device.getInfo()
    })
    .then(function (info) {
        
        console.log("Got Info", info)
    })
    .catch(function (e) {
        console.warn("Error: ", e)
    })
})

/*
Device.getInfo().then(function (info) {
    console.log("Has Info: ", info)
})
*/
